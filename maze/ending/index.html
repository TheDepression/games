<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maze Adventure: Ending</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        #endingContainer {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #mediaContainer {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #222;
            border: 3px solid #555;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #endingVideo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        
        #endingImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        
        #subtitleBox {
            width: 100%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        #navigationContainer {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #nextButton {
            display: block;
        }
        
        #congratsButton {
            background: #ff6b35;
            display: none;
            font-size: 18px;
            padding: 15px 30px;
        }
        
        #congratsButton:hover {
            background: #ff5722;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        #leaderboardSection {
            display: none;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        
        #leaderboardTitle {
            font-size: 32px;
            margin-bottom: 20px;
            color: #ff6b35;
        }
        
        #nameInput {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #444;
            border-radius: 6px;
            background: #333;
            color: white;
            margin-bottom: 20px;
            width: 200px;
        }
        
        #leaderboardTable {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }
        
        .leaderboard-entry:last-child {
            border-bottom: none;
        }
        
        .rank {
            font-weight: bold;
            color: #ff6b35;
        }
        
        #endGameButton {
            background: #666;
            margin-top: 20px;
        }
        
        #endGameButton:hover {
            background: #777;
        }
        
        .loading {
            color: #ff6b35;
            font-style: italic;
        }

        #endingVideo {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    display: none;
}

#endingVideo::-webkit-media-controls {
    display: none !important;
}

#endingVideo::-webkit-media-controls-panel {
    display: none !important;
}

#endingVideo::-webkit-media-controls-play-button {
    display: none !important;
}

#endingVideo::-webkit-media-controls-start-playback-button {
    display: none !important;
}

#endingVideo::-moz-media-controls {
    display: none !important;
}

#endingVideo::-ms-media-controls {
    display: none !important;
}

        #replayButton {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    border: none;
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
    display: none;
    z-index: 10;
}

#replayButton:hover {
    background: rgba(0, 0, 0, 0.9);
}
    </style>
</head>
<body>
    <div id="startScreen" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; text-align: center;">
        <h2>üé¨ „Ç®„É≥„Éá„Ç£„É≥„Ç∞</h2>
        <p style="font-size: 18px; margin: 20px 0;">„ÅäÁñ≤„ÇåÊßò„Åß„Åó„ÅüÔºÅ</p>
        <button class="start-button" style="background: #ff6b35; font-size: 20px; padding: 15px 30px;" onclick="startEnding()">„Ç®„É≥„Éá„Ç£„É≥„Ç∞„ÇíË¶ã„Çã</button>
    </div>

    <div id="endingContainer">
        <div id="mediaContainer">
            <video id="endingVideo" muted playsinline disablepictureinpicture>
                <source src="" type="video/quicktime">
                Your browser does not support the video element.
            </video>
            <img id="endingImage" src="" alt="Ending Scene">
            <button id="replayButton" onclick="replayVideo()">üîÑ „É™„Éó„É¨„Ç§</button>
        </div>
        <div id="subtitleBox">
            <p id="subtitleText">Loading...</p>
        </div>
        <div id="navigationContainer">
            <button id="nextButton" onclick="nextSlide()" disabled>„Å§„Åé</button>
            <button id="congratsButton" onclick="showLeaderboard()">„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ</button>
        </div>
        
        <div id="leaderboardSection">
            <h2 id="leaderboardTitle">„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ</h2>
            <div id="nameInputSection">
                <p>„ÅäÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:</p>
                <input type="text" id="nameInput" placeholder="„ÅäÂêçÂâç" maxlength="20">
                <br>
                <button onclick="submitScore()">„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°</button>
            </div>
            <div id="leaderboardTable">
                <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            </div>
            <button id="endGameButton" onclick="endGame()">„Ç≤„Éº„É†ÁµÇ‰∫Ü</button>
        </div>
    </div>

    <audio id="bgMusic" loop>
        <source src="https://raw.githubusercontent.com/TheDepression/Sounds/main/cutscene.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>

    <script>
        // Check if player has the required key
        if (localStorage.getItem('keyw') !== 'unlocked') {
            window.location.href = 'https://thedepression.github.io/games/maze/level1';
        }

        // Ending sequence data
        const endingSequence = [
            {
                type: 'video',
                src: 'https://raw.githubusercontent.com/TheDepression/Photos/main/Thumbnails/end1.MOV',
                subtitle: '„Ç¥„É™„É©„Éú„Çπ„Åå„Åü„Åä„Çå„Åü„ÅÇ„Å®‚Ä¶'
            },
            {
                type: 'video',
                src: 'https://raw.githubusercontent.com/TheDepression/Photos/main/Thumbnails/end2.MOV',
                subtitle: '„Åà„ÇÇ„Åò„Çø„Ç¶„É≥„ÅÆ „Åø„Çì„Å™„ÅØ „Åä„ÅÑ„Çè„ÅÑ„Åó„Åü„ÄÇ'
            },
            {
                type: 'image',
                src: 'https://raw.githubusercontent.com/TheDepression/Photos/main/Thumbnails/endpic1.WEBP',
                subtitle: '„Ç¥„É™„É©„Éú„Çπ„ÅØ „ÇÇ„ÅÜ „ÅÑ„Å™„Åè„Å™„Å£„Åü„ÄÇ'
            },
            {
                type: 'video',
                src: 'https://raw.githubusercontent.com/TheDepression/Photos/main/Thumbnails/end3.MOV',
                subtitle: '„Åü„Å∂„Çì„Å≠„ÄÇ'
            },
            {
                type: 'image',
                src: 'https://raw.githubusercontent.com/TheDepression/Photos/main/Thumbnails/endpic1.jpg',
                subtitle: '„Åß„ÇÇ„ÄÅ„Å©„Å°„Çâ„Å´„Åó„Å¶„ÇÇ„ÄÅ„Åà„ÇÇ„Åò„Åü„Å°„ÅØ „ÅÑ„Å§„Åß„ÇÇ „Åò„Å∂„Çì„ÅÆ„Åæ„Å°„Çí „Åæ„ÇÇ„Çã „Åò„ÇÖ„Çì„Å≥„Åå „Åß„Åç„Å¶„ÅÑ„ÅüÔºÅ'
            }
        ];

        let currentSlide = 0;
        let nextButtonTimer = null;

        // Supabase configuration (placeholder)
        const SUPABASE_URL = 'https://uhvaquliroqvjgfanmfi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVodmFxdWxpcm9xdmpnZmFubWZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MDI2OTksImV4cCI6MjA2NDI3ODY5OX0.w7P2YPbC-9pYYzHAe-S-UG6D43jijrXVV7LyGmCKn8s';

        function init() {
            // Don't start anything automatically - wait for user interaction
        }

        function startEnding() {
            // Hide start screen
            document.getElementById('startScreen').style.display = 'none';
            
            // Start background music
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.play().catch(e => console.log('Music play failed:', e));
            
            // Show first slide
            showSlide(0);
        }

        function showSlide(index) {
            // Hide replay button when changing slides
document.getElementById('replayButton').style.display = 'none';
            const video = document.getElementById('endingVideo');
            const image = document.getElementById('endingImage');
            const subtitle = document.getElementById('subtitleText');
            const nextButton = document.getElementById('nextButton');
            const congratsButton = document.getElementById('congratsButton');
            const currentItem = endingSequence[index];

            // Update subtitle
            subtitle.textContent = currentItem.subtitle;

            // Clear any existing timer
            if (nextButtonTimer) {
                clearTimeout(nextButtonTimer);
                nextButtonTimer = null;
            }

            // Disable next button initially
            nextButton.disabled = true;

            if (currentItem.type === 'video') {
                // Show video, hide image
                video.style.display = 'block';
                image.style.display = 'none';
                
                video.src = currentItem.src;
                video.load();
                
                // Enable next button when video ends
                video.onended = function() {
                    nextButton.disabled = false;
                // Show replay button for videos only
    document.getElementById('replayButton').style.display = 'block';
};
                
                // Auto-play video with better error handling
                video.play().then(() => {
                    console.log('Video started playing');
                }).catch(e => {
                    console.log('Video play failed:', e);
                    // If video fails to play, enable next button after 3 seconds
                    setTimeout(() => {
                        nextButton.disabled = false;
                    }, 3000);
                });
                
            } else {
                // Show image, hide video
                video.style.display = 'none';
                image.style.display = 'block';
                
                image.src = currentItem.src;
                
                // Add fade effect
                image.classList.add('fade-in');
                setTimeout(() => image.classList.remove('fade-in'), 500);
                
                // Enable next button after 5 seconds for images
                nextButtonTimer = setTimeout(() => {
                    nextButton.disabled = false;
                }, 5000);
            }

            // Check if this is the last slide
            if (index === endingSequence.length - 1) {
                nextButton.style.display = 'none';
                congratsButton.style.display = 'block';
            } else {
                nextButton.style.display = 'block';
                congratsButton.style.display = 'none';
            }
        }

        function nextSlide() {
            if (currentSlide < endingSequence.length - 1) {
                currentSlide++;
                showSlide(currentSlide);
            }
        }

        function replayVideo() {
    const video = document.getElementById('endingVideo');
    const nextButton = document.getElementById('nextButton');
    const replayButton = document.getElementById('replayButton');
    
    // Hide replay button and disable next button during replay
    replayButton.style.display = 'none';
    nextButton.disabled = true;
    
    // Restart video
    video.currentTime = 0;
    video.play().catch(e => console.log('Replay failed:', e));
}

        function showLeaderboard() {
            // Hide main container, show leaderboard
            document.getElementById('endingContainer').style.display = 'none';
            document.getElementById('leaderboardSection').style.display = 'block';
            
            // Check if user name is already saved
            const savedName = localStorage.getItem('mazename');
            if (savedName) {
                document.getElementById('nameInput').value = savedName;
                document.getElementById('nameInputSection').style.display = 'none';
                submitScore();
            } else {
                loadLeaderboard();
            }
        }

        async function submitScore() {
            const nameInput = document.getElementById('nameInput');
            const playerName = nameInput.value.trim() || 'Anonymous';
            const gameTime = parseInt(localStorage.getItem('totalGameTime')) || 0;

            // Save name to localStorage
            localStorage.setItem('mazename', playerName);
            
            // Hide name input section
            document.getElementById('nameInputSection').style.display = 'none';

            try {
                // Placeholder for Supabase submission
                 const response = await fetch(`${SUPABASE_URL}/rest/v1/maze_leaderboard`, {
                     method: 'POST',
                     headers: {
                         'apikey': SUPABASE_ANON_KEY,
                         'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                         'Content-Type': 'application/json',
                         'Prefer': 'return=minimal'
                     },
                     body: JSON.stringify({
                         player_name: playerName,
                         completion_time: gameTime,
                         completed_at: new Date().toISOString()
                     })
                 });

                console.log('Score submitted:', { playerName, gameTime });
                
                // Set leaderboard access key
                localStorage.setItem('mazeleaderboard', 'unlocked');
                
                // Load and display leaderboard
                await loadLeaderboard();
                
            } catch (error) {
                console.error('Error submitting score:', error);
                document.getElementById('leaderboardTable').innerHTML = 
                    '<div style="color: red;">„Ç®„É©„Éº: „Çπ„Ç≥„Ç¢„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
            }
        }

        async function loadLeaderboard() {
            try {
                // Placeholder for Supabase query
                 const response = await fetch(`${SUPABASE_URL}/rest/v1/maze_leaderboard?select=*&order=completion_time.asc&limit=25`, {
                     headers: {
                         'apikey': SUPABASE_ANON_KEY,
                         'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                     }
                 });
                 const leaderboardData = await response.json();

                // Mock data for demonstration
             //   const leaderboardData = [
                 //   { player_name: 'Player1', completion_time: 12000 },
                 //   { player_name: 'Player2', completion_time: 15000 },
                 //   { player_name: 'Player2', completion_time: 15000 },
                 //   { player_name: 'Player2', completion_time: 15000 },
              //      { player_name: 'Player3', completion_time: 18000 }
           //     ];

                displayLeaderboard(leaderboardData);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboardTable').innerHTML = 
                    '<div style="color: red;">„Ç®„É©„Éº: „É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
            }
        }

        function displayLeaderboard(data) {
            const tableDiv = document.getElementById('leaderboardTable');
            
            if (data.length === 0) {
                tableDiv.innerHTML = '<div>„Åæ„Å†„É¨„Ç≥„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            let html = '';
            data.forEach((entry, index) => {
                const minutes = Math.floor(entry.completion_time / 60000);
                const seconds = Math.floor((entry.completion_time % 60000) / 1000);
                const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                html += `
                    <div class="leaderboard-entry">
                        <span class="rank">${index + 1}.</span>
                        <span>${entry.player_name}</span>
                        <span>${timeString}</span>
                    </div>
                `;
            });
            
            tableDiv.innerHTML = html;
        }

        function formatTime(milliseconds) {
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function endGame() {
            // Stop music
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.pause();
            
            // Reset specific game data but keep name and leaderboard access
            localStorage.removeItem('MazeGameData');
            localStorage.removeItem('keyw');
            
            // Go back to level 1
            window.location.href = 'https://thedepression.github.io/games/maze/level1';
        }

        // Start when page loads
        window.onload = init;
    </script>
</body>
</html>
